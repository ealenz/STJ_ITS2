---
title: "STJ_timeseries"
output: html_document
---


```{r}
library(tidyverse)
library(janitor)
library(phyloseq)  # BiocManager::install("phyloseq")
```

# Read in SymPortal output to phyloseq
```{r}
sam0 <- read_csv("Data/STJ_Metadata_2017_2019.csv") %>%
  clean_names()
sam1 <- as.matrix(sam0)
rownames(sam1) <- sam0$sample_name
sam <- sample_data(data.frame(sam1))

tax0 <- read_tsv(
  file = "Data/20200623_lenz/its2_type_profiles/111_20200624_2020-06-24_03-40-50.238182.profiles.absolute.abund_and_meta.txt",
  n_max = 6) %>%
  dplyr::select(-2) %>% 
  gather(UID, value, -1) %>% 
  spread(1, value) %>%
  clean_names()
tax1 <- as.matrix(tax0[, -1], dimnames = list(tax0$uid, colnames(tax0[-1])))
rownames(tax1) <- tax0$uid
tax <- tax_table(tax1)

otu0 <- read_tsv(
  file = "Data/20200623_lenz/its2_type_profiles/111_20200624_2020-06-24_03-40-50.238182.profiles.absolute.abund_and_meta.txt") %>% 
  rename(sample_name = X2) %>%
  select(-1) %>%
  slice(7:n()) %>%
  mutate_at(2:ncol(.), as.numeric)
otu1 <- as.matrix(otu0[, -1])
rownames(otu1) <- otu0$sample_name
otu <- otu_table(otu1, taxa_are_rows = FALSE)

profiles <- phyloseq(otu, tax, sam)
```


# Read in coral post-QC sequence variants
```{r}
taxnames <- read_tsv(
  file = "Data/20200623_lenz/post_med_seqs/111_20200624_2020-06-24_03-40-50.238182.seqs.absolute.abund_and_meta.txt",
  n_max = 0) %>%
  select(-(1:33)) %>%
  names(.)
tax0 <- data_frame(
  DIV = taxnames,
  clade = str_extract(DIV, "[A-Z]")
)
tax1 <- as.matrix(tax0)
rownames(tax1) <- tax0$DIV
tax <- tax_table(tax1)

otu0 <- read_tsv(
  file = "Data/20200623_lenz/post_med_seqs/111_20200624_2020-06-24_03-40-50.238182.seqs.absolute.abund_and_meta.txt") %>% 
  select(-1, -(3:33))
otu1 <- as.matrix(otu0[, -1])
rownames(otu1) <- otu0$sample_name
otu <- otu_table(otu1, taxa_are_rows = FALSE)

variants <- phyloseq(otu, tax, sam)
```


```{r}
ntaxa(variants)
ntaxa(profiles)

min(sample_sums(variants))
max(sample_sums(variants))
hist(log10(sample_sums(variants)))
mean(sample_sums(variants))
sd(sample_sums(variants))/sqrt(nsamples(variants))

# Transform to relative abundance
variants <- transform_sample_counts(variants, fun = function(x) x / sum(x))
profiles <- transform_sample_counts(profiles, fun = function(x) x / sum(x))
```


# Plot
```{r}
# Subset colonies sampled in all three years
all3 <- sample_data(profiles) %>%
  group_by(host_id) %>%
  filter(n() == 3) %>%
  distinct(host_id) %>%
  pull(host_id)

plot_both <- function(mycol) {
  s <- subset(sample_data(variants), host_id == mycol)
  v <- merge_phyloseq(tax_table(variants), otu_table(variants), s)
  p <- merge_phyloseq(tax_table(profiles), otu_table(profiles), s)
  v <- prune_taxa(taxa_sums(v) != 0, v)
  p <- prune_taxa(taxa_sums(p) != 0, p)
  v_plot <- plot_bar(v, fill = "DIV") + theme(legend.position = "none")
  p_plot <- plot_bar(p, fill = "its2_type_profile") + 
    theme(legend.position = c(0.5, 0.5), legend.text = element_text(size = 5),
          legend.title = element_blank())
  cowplot::plot_grid(p_plot, v_plot)
}

all3
plot_both(mycol = all3[1]) #ET Ssid, fidelity
plot_both(mycol = all3[2]) #ET Ssid, fidelity
plot_both(mycol = all3[3]) #ET Ofra, fidelity
plot_both(mycol = all3[4]) #CH Ofra, fidelity
plot_both(mycol = all3[5]) #CH Ofra 2019 shift in profile but not much in variants
plot_both(mycol = all3[6]) #Error in validObject
plot_both(mycol = all3[7]) #CH Mcav, fidelity with some background switching
plot_both(mycol = all3[8]) #ET Mcav 
plot_both(mycol = all3[9]) #CH Mcav 2018 more variants
plot_both(mycol = all3[10]) #Error in validObject
plot_both(mycol = all3[11]) #ET Mcav
plot_both(mycol = all3[12]) #CH Pstr
plot_both(mycol = all3[13]) #CH Cnat
plot_both(mycol = all3[14]) #ET Cnat
plot_both(mycol = all3[15]) #ET Cnat
plot_both(mycol = all3[16]) #ET Cnat
plot_both(mycol = all3[17]) #ET Pstr
plot_both(mycol = all3[18]) #Error in validObject
plot_both(mycol = all3[19]) #CH Dlab
plot_both(mycol = all3[20]) #ET Dlab
plot_both(mycol = all3[21]) #ET Dlab
plot_both(mycol = all3[22]) #CH Cnat
plot_both(mycol = all3[23]) #Error in validObject
plot_both(mycol = all3[24]) #ET Pstr
plot_both(mycol = all3[25]) #ET Dlab
plot_both(mycol = all3[26]) #CH Dlab
plot_both(mycol = all3[27]) #CH Ssid
plot_both(mycol = all3[28]) #CH Oann
plot_both(mycol = all3[29]) #CH Oann
```

# Save

```{r}
save(profiles, variants, file = "data/Symb_phyloseq.RData")
```


```{r}
# Subset colonies sampled in 2 years
all2 <- sample_data(profiles) %>%
  group_by(host_id) %>%
  filter(n() == 2) %>%
  distinct(host_id) %>%
  pull(host_id)

plot_both <- function(mycol) {
  s <- subset(sample_data(variants), host_id == mycol)
  v <- merge_phyloseq(tax_table(variants), otu_table(variants), s)
  p <- merge_phyloseq(tax_table(profiles), otu_table(profiles), s)
  v <- prune_taxa(taxa_sums(v) != 0, v)
  p <- prune_taxa(taxa_sums(p) != 0, p)
  v_plot <- plot_bar(v, fill = "DIV") + theme(legend.position = "none")
  p_plot <- plot_bar(p, fill = "its2_type_profile") + 
    theme(legend.position = c(0.5, 0.5), legend.text = element_text(size = 5),
          legend.title = element_blank())
  cowplot::plot_grid(p_plot, v_plot)
}

all2
plot_both(mycol = all2[1])
plot_both(mycol = all2[2])
plot_both(mycol = all2[3])
plot_both(mycol = all2[4])
plot_both(mycol = all2[5])   #####
plot_both(mycol = all2[6])
plot_both(mycol = all2[7])
plot_both(mycol = all2[8])
plot_both(mycol = all2[9])
plot_both(mycol = all2[10])
plot_both(mycol = all2[11])
plot_both(mycol = all2[12])
plot_both(mycol = all2[13])
plot_both(mycol = all2[14])
plot_both(mycol = all2[15])
plot_both(mycol = all2[16])
plot_both(mycol = all2[17])
plot_both(mycol = all2[18])
plot_both(mycol = all2[19])
plot_both(mycol = all2[20])
plot_both(mycol = all2[21])
plot_both(mycol = all2[22])
plot_both(mycol = all2[23])
plot_both(mycol = all2[24])
plot_both(mycol = all2[25])
plot_both(mycol = all2[26])
plot_both(mycol = all2[27])

```
