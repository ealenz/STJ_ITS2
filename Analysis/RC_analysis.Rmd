---
title: "St. John symbiont time series"
author: "R. Cunning"
date: "2/16/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```

```{r libraries}
library(tidyverse)
library(janitor)
library(phyloseq)  # BiocManager::install("phyloseq")
library(cowplot)
library(ggrepel)
library(scales)
library(RColorBrewer)
```

# Load Data
```{r profiles, include = FALSE}
sam0 <- read_csv("Data/STJ_Metadata_2017_2019.csv") %>%
  clean_names()
sam1 <- as.matrix(sam0)
rownames(sam1) <- sam0$sample_name
sam <- sample_data(data.frame(sam1))

tax0 <- read_tsv(
  file = "Data/20200623_lenz/its2_type_profiles/111_20200624_2020-06-24_03-40-50.238182.profiles.absolute.abund_and_meta.txt",
  n_max = 6) %>%
  dplyr::select(-2) %>% 
  gather(UID, value, -1) %>% 
  spread(1, value) %>%
  clean_names()
tax1 <- as.matrix(tax0[, -1], dimnames = list(tax0$uid, colnames(tax0[-1])))
rownames(tax1) <- tax0$uid
tax <- tax_table(tax1)

otu0 <- read_tsv(
  file = "Data/20200623_lenz/its2_type_profiles/111_20200624_2020-06-24_03-40-50.238182.profiles.absolute.abund_and_meta.txt") %>% 
  rename(sample_name = X2) %>%
  select(-1) %>%
  slice(7:n()) %>%
  mutate_at(2:ncol(.), as.numeric)
otu1 <- as.matrix(otu0[, -1])
rownames(otu1) <- otu0$sample_name
otu <- otu_table(otu1, taxa_are_rows = FALSE)

profiles <- phyloseq(otu, tax, sam)
```

```{r variants, include = FALSE}
taxnames <- read_tsv(
  file = "Data/20200623_lenz/post_med_seqs/111_20200624_2020-06-24_03-40-50.238182.seqs.absolute.abund_and_meta.txt",
  n_max = 0) %>%
  select(-(1:33)) %>%
  names(.)
tax0 <- data_frame(
  DIV = taxnames,
  clade = str_extract(DIV, "[A-Z]")
)
tax1 <- as.matrix(tax0)
rownames(tax1) <- tax0$DIV
tax <- tax_table(tax1)

otu0 <- read_tsv(
  file = "Data/20200623_lenz/post_med_seqs/111_20200624_2020-06-24_03-40-50.238182.seqs.absolute.abund_and_meta.txt") %>% 
  select(-1, -(3:33))
otu1 <- as.matrix(otu0[, -1])
rownames(otu1) <- otu0$sample_name
otu <- otu_table(otu1, taxa_are_rows = FALSE)

variants <- phyloseq(otu, tax, sam)
```

```{r save, include = FALSE}
save(profiles, variants, file = "data/Symb_phyloseq.RData")
```

```{r QC, include = FALSE}
# Filter out samples with low read counts
low <- sample_sums(variants) < 1000
variants <- subset_samples(variants, !low)
variants <- prune_taxa(taxa_sums(variants) != 0, variants)
profiles <- subset_samples(profiles, !low)
profiles <- prune_taxa(taxa_sums(profiles) != 0, profiles)

# Filter out RANDOM samples (non-tagged colonies)
variants <- subset_samples(variants, host_id != "RANDOM")
variants <- prune_taxa(taxa_sums(variants) != 0, variants)
profiles <- subset_samples(profiles, host_id != "RANDOM")
profiles <- prune_taxa(taxa_sums(profiles) != 0, profiles)

# Filter out P. furcata (only one colony sampled after first tagging)
variants <- subset_samples(variants, host_species != "furcata")
variants <- prune_taxa(taxa_sums(variants) != 0, variants)
profiles <- subset_samples(profiles, host_species != "furcata")
profiles <- prune_taxa(taxa_sums(profiles) != 0, profiles)

# Read count analysis
# ntaxa(variants)
# ntaxa(profiles)
# min(sample_sums(variants))
# max(sample_sums(variants))
# mean(sample_sums(variants))
# sd(sample_sums(variants))/sqrt(nsamples(variants))

hist(log10(sample_sums(variants)))
```

# Create custom functions, color palettes, and ggplot themes
```{r color_palettes, include = FALSE}
# Create standardized color pallettes for plotting profiles and variants

#ppal <- sample(allcolors, ntaxa(profiles))
#ppal <- hue_pal(l = 65)(ntaxa(profiles))
qual_col_pals = brewer.pal.info[brewer.pal.info$category == 'qual',]
col_vector = unlist(mapply(brewer.pal, qual_col_pals$maxcolors, rownames(qual_col_pals)))
set.seed(555)
ppal <- sample(col_vector, ntaxa(profiles))
ppal <- setNames(ppal, data.frame(tax_table(profiles))$its2_type_profile)

allcolors <- grDevices::colors()
set.seed(888)
vpal <- sample(allcolors, ntaxa(variants))
#vpal <- hue_pal(l = 65)(ntaxa(variants))
vpal <- setNames(vpal, taxa_names(variants))
```

```{r plotting_functions, include = FALSE}
# Plotting functions
plot_both <- function(mycol) {
  s <- subset(sample_data(variants), host_id == mycol)
  v <- merge_phyloseq(tax_table(variants), otu_table(variants), s)
  p <- merge_phyloseq(tax_table(profiles), otu_table(profiles), s)
  v <- prune_taxa(taxa_sums(v) != 0, v)
  p <- prune_taxa(taxa_sums(p) != 0, p)
  vmdf <- psmelt(v)
  seqdepth <- vmdf %>%
    group_by(year) %>%
    summarize(sum = paste0("n=", sum(Abundance)))
  ti <- paste0(vmdf[1, c("host_genus", "host_species", "host_id", "host_site")], collapse = " ")
  v_plot <- ggplot(vmdf, aes(x = year, y = Abundance, fill = DIV, label = DIV)) + 
    geom_bar(stat = "identity", position = "fill", color = "black", lwd = 0.1) + 
    scale_x_discrete(expand = c(0, 0)) +
    scale_y_continuous(expand = expansion(mult = c(0, .1)), labels = scales::percent) +
    scale_fill_manual(values = vpal[vmdf$OTU]) +
    geom_text(aes(size = Abundance), position = position_fill(vjust = 0.5)) +
    geom_text(data = seqdepth, aes(x = year, y = 1.01, label = sum), vjust = 0, size = 3, inherit.aes = FALSE) +
    theme(legend.position = "none", panel.background = element_blank(), 
          axis.title.x = element_blank(), axis.title.y = element_blank()) +
    coord_cartesian(ylim = c(0, 1))
  pmdf <- psmelt(p)
  p_plot <- ggplot(pmdf, aes(x = year, y = Abundance, fill = its2_type_profile, label = its2_type_profile)) +
    geom_bar(stat = "identity", position = "fill", color = "black", lwd = 0.1) +
    scale_x_discrete(expand = c(0, 0)) +
    scale_y_continuous(expand = expansion(mult = c(0, .1)), labels = scales::percent) +
    scale_fill_manual(values = ppal[pmdf$its2_type_profile]) +
    geom_label_repel(position = position_fill(vjust = 0.5), force = 2,
                     point.size = NA, xlim = c(-0.1, 3.6), ylim = c(0.1,0.9), size = 2) +
    theme(legend.position = "none", panel.background = element_blank(), 
          axis.title.x = element_blank(), axis.title.y = element_blank()) +
    coord_cartesian(clip = "off")
  plot_row <- plot_grid(p_plot, v_plot, labels = c("ITS2 Profiles", "ITS2 Variants"), label_fontface = "plain")
  title <- ggdraw() + 
    draw_label(ti, fontface = 'bold', x = 0, hjust = 0) +
    theme(plot.margin = margin(0, 0, 0, 7))
  plot_grid(title, plot_row, ncol = 1, rel_heights = c(0.1, 1))
}

#plot_both(mycol = all3[1])

# Plot by species and site
# ordf <- data.frame(sam) %>%
#   distinct(host_id, host_genus, host_species, host_site) %>%
#   filter(host_id != "RANDOM") %>%
#   filter(host_id %in% all3) %>%
#   arrange(host_genus, host_species, host_site)



# new plotting function to condense by species rather than by individual
plot_both2 <- function(...) {
  s <- subset(sample_data(variants), ...)
  v <- merge_phyloseq(tax_table(variants), otu_table(variants), s)
  p <- merge_phyloseq(tax_table(profiles), otu_table(profiles), s)
  v <- prune_taxa(taxa_sums(v) != 0, v)
  p <- prune_taxa(taxa_sums(p) != 0, p)
  vmdf <- psmelt(v)
  seqdepth <- vmdf %>%
    group_by(year) %>%
    summarize(sum = paste0("n=", sum(Abundance)))
  ti <- paste0(vmdf[1, c("host_genus", "host_species")], collapse = " ")
  v_plot <- ggplot(vmdf, aes(x = year, y = Abundance, fill = DIV, label = DIV)) + 
    geom_bar(stat = "identity", position = "fill") + 
    facet_wrap(~ host_site + host_id, nrow = 1) +
    scale_x_discrete(expand = c(0, 0)) +
    scale_y_continuous(expand = expansion(mult = c(0, .1)), labels = scales::percent) +
    ylab("ITS2 sequences") +
    scale_fill_manual(values = vpal[vmdf$OTU]) +
    # geom_text(aes(size = Abundance), position = position_fill(vjust = 0.5)) +
    # geom_text(data = seqdepth, aes(x = year, y = 1.01, label = sum), vjust = 0, size = 3, inherit.aes = FALSE) +
    theme(legend.position = "none", panel.background = element_blank(), 
          axis.title.x = element_blank(), axis.text.x = element_blank(),
          axis.text.y = element_blank(), axis.ticks.y = element_blank()) +
    coord_cartesian(ylim = c(0, 1))
  pmdf <- psmelt(p)
  p_plot <- ggplot(pmdf, aes(x = year, y = Abundance, fill = its2_type_profile, label = its2_type_profile)) +
    geom_bar(stat = "identity", position = "fill") +
    facet_wrap(~ host_site + host_id, nrow = 1) +
    scale_x_discrete(expand = c(0, 0)) +
    scale_y_continuous(expand = expansion(mult = c(0, .1)), labels = scales::percent) +
    ylab("Profiles") +
    scale_fill_manual(values = ppal[pmdf$its2_type_profile]) +
    # geom_label_repel(position = position_fill(vjust = 0.5), force = 2,
    #                  point.size = NA, xlim = c(-0.1, 3.6), ylim = c(0.1,0.9), size = 2) +
    theme(legend.position = "bottom", panel.background = element_blank(), 
          axis.title.x = element_blank(), axis.text.x = element_text(angle = 90),
          axis.text.y = element_blank(), axis.ticks.y = element_blank(),
          strip.background = element_blank(), strip.text.x = element_blank())# +
    #guides(fill = guide_legend(nrow = 4)) # +
    #coord_cartesian(clip = "off")
  plot_grid(v_plot, p_plot, nrow = 2, label_fontface = "plain")
}
```

```{r ggplot_theme}
# Create custom ggplot theme
theme_custom <- function() {
  theme_bw(base_size = 10, base_family = "Arial") %+replace%
    theme(
      panel.grid.major = element_blank(), 
      panel.grid.minor = element_blank(), 
      panel.background = element_blank(),
      panel.border = element_rect(color = "black", fill = NA),
      legend.background = element_rect(fill = NA, colour = NA)
    )
}

scale_color_corals <- function(...){
    ggplot2:::manual_scale(
        c('color', 'fill'),
        values = setNames(c('#00BFC4', '#CD9600', '#7CAE00', '#00BE67', 
                            '#F8766D', '#00A9FF', '#C77CFF', '#FF61CC'),
                          c('annularis', 'cavernosa', 'faveolata', 'franksi', 
                            'labrynthiformis', 'natans', 'siderea', 'strigosa')), 
        ...
    )
}
```

# 1. Symbiont community variability

### Ordination for all coral samples
```{r}
# Convert to relative abundance - and square root transform
varr <- transform_sample_counts(variants, function(x) sqrt(x/sum(x)))     # Square-root transform

# Run NMDS for visualization
set.seed(53)
varr.nmds <- ordinate(varr, "NMDS", "bray")
varr.nmds.s <- plot_ordination(varr, varr.nmds, type="samples")
varr.nmds.t <- plot_ordination(varr, varr.nmds, type="taxa")

# Calculate centroids for each species for plotting
centroids <- varr.nmds.s$data %>%
  group_by(host_species) %>%
  summarise(across(starts_with("NMDS"), mean, .names = "o{.col}")) %>%
  right_join(varr.nmds.s$data)

# Plot NMDS
nmds_plot <- ggplot(centroids, aes(x = NMDS1, y = NMDS2, color = host_species)) +
  geom_point() +
  geom_segment(aes(xend = oNMDS1, yend = oNMDS2)) +
  theme_custom() +
  scale_color_corals(); nmds_plot

# Calculate beta diversity as distance to centroid (PCoA) for each host species
bd <- vegan::betadisper(d = distmat, group = sample_data(varr)$host_species,
                        type = "centroid", bias.adjust = FALSE)
bdres <- as_tibble(sample_data(varr)) %>%
  select(host_id, year, sample_name, host_species) %>%
  mutate(dist_to_centroid = bd$distances)

# Analyze differences in distance to centroid among coral species
mod <- lm(dist_to_centroid ~ host_species, data = bdres)
anova(mod)
emm <- emmeans(mod, specs = "host_species") %>%
  as_tibble() %>%
  mutate(host_species = fct_reorder(host_species, emmean, .desc = TRUE))

# Plot beta diversity
bd_plot <- ggplot(emm, aes(x = host_species, y = emmean, color = host_species)) +
  geom_col(aes(fill = host_species), width = 0.8) +
  geom_errorbar(aes(ymin = emmean - SE, ymax = emmean + SE), width = 0) +
  geom_text(aes(label = host_species, y = 0.01), color = "black", hjust = 0, angle = 90, size = 3) +
  theme_custom() +
  scale_color_corals() +
  theme(axis.text.x = element_text(color = "white")) +
  theme(legend.position = "none") +
  labs(x = "Coral species", y = "Distance to centroid"); bd_plot

# Multipanel figure
legend <- get_legend(nmds_plot)
nmds_plot_nolegend <- nmds_plot + theme(legend.position = "none")
right_side <- plot_grid(legend, bd_plot, ncol = 1)
cowplot::plot_grid(nmds_plot_nolegend, right_side, nrow = 1, rel_widths = c(0.7, 0.3))


```


```{r}
# Bray-Curtis distance matrix
distmat <- vegan::vegdist(otu_table(varr), method = "bray")

# Principal Coordinates Analysis
varrdf <- as.data.frame(cmdscale(distmat, k = 50)) %>%      # Specify k dimensions   #####
  mutate(sample_name = rownames(.)) %>%
  left_join(sample_data(varr)) %>%
  as_tibble() %>%
  select(starts_with("V"), host_species, host_id, year, host_site, collection_depth) %>%
  arrange(host_id, year)

# Calculate distance moved (in ordination space) from year to year for each colony 
dists <- varrdf %>%
  group_by(host_id) %>%
  #filter(n() == 3) %>%
  nest(data = c(year, starts_with("V"))) %>%
  mutate(years = map(data, ~.[,1]),
         points = map(data, ~.[,-1])) %>%
  mutate(d = map(points, dist),
         pd = map(d, broom::tidy)) %>%
  unnest(pd) %>%
  mutate(y1 = map2_chr(item1, years, ~case_when(.x == 1 ~ .y[[1]][1],
                                                .x == 2 ~ .y[[1]][2])),
         y2 = map2_chr(item2, years, ~case_when(.x == 2 ~ .y[[1]][2],
                                                .x == 3 ~ .y[[1]][3]))) %>%
  select(host_id, host_species, host_site, y1, y2, distance) %>%
  rowwise() %>%
  mutate(period = paste(y1, y2, sep = "-"))
dists

dists  %>% filter(host_species == "natans") %>% arrange(-distance)

# Plot movement by species
dists %>%
  mutate(gap = as.numeric(y2) - as.numeric(y1)) %>%
  filter(gap == min(gap)) %>%                         # selects 1-year gaps only for cols sampled 3x
  ggplot(aes(x = host_species, y = distance)) +
  geom_violin() +
  geom_point(aes(color = host_site))

# Plot movement by year / species
ggplot(dists, aes(x = interaction(y1,y2), y = distance, color = host_species)) +
  geom_point()


mod <- lmer(log(distance) ~ period * host_species + (1|host_id), data = filter(dists, period %in% c("2017-2018", "2017-2019")))
hist(residuals(mod))
car::Anova(mod)
emm <- emmeans(mod, specs = c("period", "host_species"), type = "response")
contrast(emm, by = "host_species")

# Get model means and combine with zeros as baseline
res <- as_tibble(emm) %>%
  filter(period %in% c("2017-2018", "2017-2019")) %>%
  full_join(tibble(period = "2017", distinct(varrdf, host_species), response = 0)) %>%
  mutate(host_species = fct_reorder(host_species, response, .desc = TRUE))

# Plot
res %>%
  ggplot(aes(x = period, y = response, color = host_species, group = host_species)) + 
  geom_point(position = position_dodge(width = 0.3)) +
  geom_errorbar(aes(ymin = response - SE, ymax = response + SE), position = position_dodge(width = 0.3), width = 0.1) +
  geom_line(position = position_dodge(width = 0.3))






varr.nmds <- ordinate(varr, method="NMDS", distance="bray", k=2)
varr.nmds$stress  # Stress value
varr.nmds.s <- plot_ordination(varr, varr.nmds, type="samples")
varr.nmds.t <- plot_ordination(varr, varr.nmds, type="taxa")

ggplot(varr.nmds.t$data, aes(x = NMDS1, y = NMDS2)) +
  geom_point(aes(shape = clade)) +
  geom_point(data = varr.nmds.s$data, aes(color = host_species)) +
  #geom_label(data = varr.nmds.s$data, aes(label = host_id)) +
  geom_path(data = varr.nmds.s$data, aes(group = host_id, color = host_species),
            arrow = arrow(length = unit(0.1, "inches"), type = "open")) +
  scale_shape_manual(values = 1:5)
```

# Ecological data from Pete
```{r}
ecodat <- readxl::read_xls("Data/For_Cunning_Lenz_paper copy.xls") %>%
  clean_names()

ecomd <- ecodat %>% select(1:5)
ecocomp <- ecodat %>% select(9:ncol(ecodat))

ecolong <- ecodat %>%
  pivot_longer(cols = 6:ncol(ecodat), names_to = "tax")

mod <- lmer(log(value+0.001) ~ tax * factor(year) + (1|quadrat/site), data = ecolong)
car::Anova(mod)

as_tibble(emmeans(mod, specs = c("year", "tax"))) %>%
  filter(tax %in% c("orbicella", "diploria", "montastraea", "montastrea_cav", "colpophyllia", "siderastrea")) %>%
  ggplot(aes(x = year, y = emmean, color = tax, group = tax)) +
  geom_point() +
  geom_line()
  
```



# Summary figures for each species

The top row of bars shows all ITS2 sequence variants, while the bottom row of bars shows the associated ITS2 profiles. Legend refers to profiles only, not variants.

### *Colpophyllia natans*
```{r natans_summary, fig.width = 11}
plot_both2(host_species == "natans")
```

*C. natans* colonies at Cabritte Horn and East Tektite were dominated by a few different *Breviolum* profiles, with low levels of *Cladocopium* and *Durusdinium* that fluctuated randomly over time. At White Point, one colony was dominated by *Cladocopium* and one by *Durusdinium*.

```{r}
# NMDS for C. natans
cnat <- merge_phyloseq(tax_table(variants), otu_table(variants), 
                       subset(sample_data(variants), host_species == "natans"))
cnat <- prune_taxa(taxa_sums(cnat) != 0, cnat)
cnatr = transform_sample_counts(cnat, function(x) x/sum(x))

cnatdistmat <- vegan::vegdist(sqrt(otu_table(cnatr)), method = "bray")

cnatdf <- as.data.frame(cmdscale(cnatdistmat, k = 2)) %>%
  mutate(sample_name = rownames(.)) %>%
  left_join(sample_data(cnat)) %>%
  as_tibble() %>%
  select(V1, V2, sample_name, host_id, year, host_site, collection_depth) %>%
  arrange(host_id, year)

ggplot(cnatdf, aes(x = V1, y = V2, color = host_id)) +
  geom_point(aes(shape = year)) +
  geom_path(aes(group = host_id), arrow = arrow(length = unit(0.1, "inches"), type = "open"))

# Subset just the B-dom corals
cnat <- merge_phyloseq(tax_table(variants), otu_table(variants), 
                       subset(sample_data(variants), host_species == "natans" & 
                                                     host_id %in% c("12", "5", "33", "35", "60", "61")))
cnat <- prune_taxa(taxa_sums(cnat) != 0, cnat)
cnatr = transform_sample_counts(cnat, function(x) x/sum(x))

cnatdistmat <- vegan::vegdist(sqrt(otu_table(cnatr)), method = "bray")

cnatdf <- as.data.frame(cmdscale(cnatdistmat, k = 2)) %>%
  mutate(sample_name = rownames(.)) %>%
  left_join(sample_data(cnat)) %>%
  as_tibble() %>%
  select(V1, V2, sample_name, host_id, year, host_site, collection_depth) %>%
  arrange(host_id, year)

ggplot(cnatdf, aes(x = V1, y = V2, color = host_id)) +
  geom_point(aes(shape = year)) +
  geom_path(aes(group = host_id), arrow = arrow(length = unit(0.1, "inches"), type = "open")) +
  labs(title = "Just Breviolum-dominated C. natans")
```

### *Diploria labyrinithiformis*
```{r labrynthiformis_summary, fig.width = 11}
plot_both2(host_species == "labrynthiformis")
```

One colony at East Tektite (57) was dominated by *Cladocopium*, but otherwise *D. labyrinthiformis* was dominated by several distinct *Breviolum* profiles. These mostly remained the same over time within colonies, but changed for a few (colony 36, 37, 62). Will have to dig into these to see if these may be real changes or analytical artifacts. 

```{r}
# NMDS for D. lab
dlab <- merge_phyloseq(tax_table(variants), otu_table(variants), 
                       subset(sample_data(variants), host_species == "labrynthiformis"))
dlab <- prune_taxa(taxa_sums(dlab) != 0, dlab)
dlabr = transform_sample_counts(dlab, function(x) sqrt(x/sum(x)))

dlabdistmat <- vegan::vegdist(sqrt(otu_table(dlabr)), method = "bray")

dlabdf <- as.data.frame(cmdscale(dlabdistmat, k = 2)) %>%
  mutate(sample_name = rownames(.)) %>%
  left_join(sample_data(dlab)) %>%
  as_tibble() %>%
  select(V1, V2, sample_name, host_id, year, host_site, collection_depth) %>%
  arrange(host_id, year)

ggplot(dlabdf, aes(x = V1, y = V2, color = host_id)) +
  geom_point(aes(shape = year)) +
  geom_path(aes(group = host_id), arrow = arrow(length = unit(0.1, "inches"), type = "open"))

# Just B-dom Dlab
dlab <- merge_phyloseq(tax_table(variants), otu_table(variants), 
                       subset(sample_data(variants), host_species == "labrynthiformis" &
                                                     host_id %in% c("13", "50", "36", "37", "62", "20", "23")))
dlab <- prune_taxa(taxa_sums(dlab) != 0, dlab)
dlabr = transform_sample_counts(dlab, function(x) x/sum(x))

dlabdistmat <- vegan::vegdist(sqrt(otu_table(dlabr)), method = "bray")

dlabdf <- as.data.frame(cmdscale(dlabdistmat, k = 2)) %>%
  mutate(sample_name = rownames(.)) %>%
  left_join(sample_data(dlab)) %>%
  as_tibble() %>%
  select(V1, V2, sample_name, host_id, year, host_site, collection_depth) %>%
  arrange(host_id, year)

ggplot(dlabdf, aes(x = V1, y = V2, color = host_id)) +
  geom_point(aes(shape = year)) +
  geom_path(aes(group = host_id), arrow = arrow(length = unit(0.1, "inches"), type = "open")) +
  labs(title = "Just Breviolum-dominated D.lab.")
```

### *Porites furcata*
```{r labrynthiformis_summary, fig.width = 11}
plot_both2(host_species == "furcata")
```

```{r}
# NMDS for P. fur
pfur <- merge_phyloseq(tax_table(variants), otu_table(variants), 
                       subset(sample_data(variants), host_species == "furcata"))
pfur <- prune_taxa(taxa_sums(pfur) != 0, pfur)
pfurr = transform_sample_counts(pfur, function(x) x/sum(x))

pfurdistmat <- vegan::vegdist(sqrt(otu_table(pfurr)), method = "bray")

pfurdf <- as.data.frame(cmdscale(pfurdistmat, k = 2)) %>%
  mutate(sample_name = rownames(.)) %>%
  left_join(sample_data(pfur)) %>%
  as_tibble() %>%
  select(V1, V2, sample_name, host_id, year, host_site, collection_depth) %>%
  arrange(host_id, year)

ggplot(pfurdf, aes(x = V1, y = V2, color = host_id)) +
  geom_point(aes(shape = year)) +
  geom_path(aes(group = host_id), arrow = arrow(length = unit(0.1, "inches"), type = "open"))
```

### *Montastraea cavernosa*
```{r cavernosa_summary, fig.width = 11}
plot_both2(host_species == "cavernosa")
```

*M. cavernosa* is dominated by a couple of different *Cladocopium* profiles with some background *Breviolum*. Two colonies at White Point have a distinct *Cladocopium* profile, but there doesn't appear to be any particular change over time.

```{r}
# NMDS for Mcav
mcav <- merge_phyloseq(tax_table(variants), otu_table(variants), 
                       subset(sample_data(variants), host_species == "cavernosa"))
mcav <- prune_taxa(taxa_sums(mcav) != 0, mcav)
mcavr = transform_sample_counts(mcav, function(x) sqrt(x/sum(x)))

mcavdistmat <- vegan::vegdist(sqrt(otu_table(mcavr)), method = "bray")

mcavdf <- as.data.frame(cmdscale(mcavdistmat, k = 2)) %>%
  mutate(sample_name = rownames(.)) %>%
  left_join(sample_data(mcav)) %>%
  as_tibble() %>%
  select(V1, V2, sample_name, host_id, year, host_site, collection_depth) %>%
  arrange(host_id, year)

ggplot(mcavdf, aes(x = V1, y = V2, color = host_id)) +
  geom_point(aes(shape = year)) +
  geom_path(aes(group = host_id), arrow = arrow(length = unit(0.1, "inches"), type = "open"))
```

### *Orbicella spp.*
```{r orbicella_summary, fig.width = 11}
plot_both2(host_genus == "Orbicella")
```

*Orbicella* colonies are sometimes dominated by *Symbiodinium*, *Breviolum*, and *Cladocopium*. Most stay the same over time, but some colonies (24 and 64, both at White Point), have mixtures of *Symbiodinium* and  *Cladocopium* in 2017, and then only *Cladocopium* in 2019. Another colony at White Point (17) appears to change between two *Cladocopium* profiles. At other sites, little evidence of change over time.

```{r}
# NMDS for Orbicella
orb <- merge_phyloseq(tax_table(variants), otu_table(variants), 
                       subset(sample_data(variants), host_genus == "Orbicella"))
orb <- prune_taxa(taxa_sums(orb) != 0, orb)
orbr = transform_sample_counts(orb, function(x) x/sum(x))

orbdistmat <- vegan::vegdist(sqrt(otu_table(orbr)), method = "bray")

orbdf <- as.data.frame(cmdscale(orbdistmat, k = 2)) %>%
  mutate(sample_name = rownames(.)) %>%
  left_join(sample_data(orb)) %>%
  as_tibble() %>%
  select(V1, V2, sample_name, host_id, year, host_site, host_species, collection_depth) %>%
  arrange(host_id, year)

ggplot(orbdf, aes(x = V1, y = V2, color = host_species)) +
  geom_point(aes(shape = year)) +
  geom_path(aes(group = host_id), arrow = arrow(length = unit(0.1, "inches"), type = "open"))


# Just Orb that are Cdom the whole time
orb <- merge_phyloseq(tax_table(variants), otu_table(variants), 
                       subset(sample_data(variants), host_genus == "Orbicella" & 
                                        host_id %in% c("3", "47", "56", "80", "81", "40", "18", "65", "67")))
orb <- prune_taxa(taxa_sums(orb) != 0, orb)
orbr = transform_sample_counts(orb, function(x) x/sum(x))

orbdistmat <- vegan::vegdist(sqrt(otu_table(orbr)), method = "bray")

orbdf <- as.data.frame(cmdscale(orbdistmat, k = 2)) %>%
  mutate(sample_name = rownames(.)) %>%
  left_join(sample_data(orb)) %>%
  as_tibble() %>%
  select(V1, V2, sample_name, host_id, year, host_site, host_species, collection_depth) %>%
  arrange(host_id, year)

ggplot(orbdf, aes(x = V1, y = V2, color = host_species)) +
  geom_point(aes(shape = year)) +
  geom_path(aes(group = host_id), arrow = arrow(length = unit(0.1, "inches"), type = "open")) +
  labs(title = "Just Cladocopium-dominated Orbicella")

# Orb that had multiple clades
orb <- merge_phyloseq(tax_table(variants), otu_table(variants), 
                       subset(sample_data(variants), host_genus == "Orbicella" & 
                                        host_id %in% c("17", "24", "64")))
orb <- prune_taxa(taxa_sums(orb) != 0, orb)
orbr = transform_sample_counts(orb, function(x) x/sum(x))

orbdistmat <- vegan::vegdist(sqrt(otu_table(orbr)), method = "bray")

orbdf <- as.data.frame(cmdscale(orbdistmat, k = 2)) %>%
  mutate(sample_name = rownames(.)) %>%
  left_join(sample_data(orb)) %>%
  as_tibble() %>%
  select(V1, V2, sample_name, host_id, year, host_site, host_species, collection_depth) %>%
  arrange(host_id, year)

ggplot(orbdf, aes(x = V1, y = V2, color = host_species)) +
  geom_point(aes(shape = year)) +
  geom_path(aes(group = host_id), arrow = arrow(length = unit(0.1, "inches"), type = "open")) +
  labs(title = "Orbicella that changed dominant clade")
```

### *Pseudodiploria strigosa*
```{r strigosa_summary, fig.width = 11}
plot_both2(host_species == "strigosa")
```

*P. strigosa* colonies contain mostly *Breviolum* profiles, with some evidences for changes among *Breviolum* types over time. Two colonies at East Tektite (45 and 54) are dominated by *Cladocopium*.

```{r}
# NMDS for Pstr
pstr <- merge_phyloseq(tax_table(variants), otu_table(variants), 
                       subset(sample_data(variants), host_species == "strigosa"))
pstr <- prune_taxa(taxa_sums(pstr) != 0, pstr)
pstrr = transform_sample_counts(pstr, function(x) x/sum(x))

pstrdistmat <- vegan::vegdist(sqrt(otu_table(pstrr)), method = "bray")

pstrdf <- as.data.frame(cmdscale(pstrdistmat, k = 2)) %>%
  mutate(sample_name = rownames(.)) %>%
  left_join(sample_data(pstr)) %>%
  as_tibble() %>%
  select(V1, V2, sample_name, host_id, year, host_site, collection_depth) %>%
  arrange(host_id, year)

ggplot(pstrdf, aes(x = V1, y = V2, color = host_id)) +
  geom_point(aes(shape = year)) +
  geom_path(aes(group = host_id), arrow = arrow(length = unit(0.1, "inches"), type = "open"))

# Just Bdom Pstr
pstr <- merge_phyloseq(tax_table(variants), otu_table(variants), 
                       subset(sample_data(variants), host_species == "strigosa" & 
                                host_id %in% c("10", "82", "42", "28", "66", "68")))
pstr <- prune_taxa(taxa_sums(pstr) != 0, pstr)
pstrr = transform_sample_counts(pstr, function(x) x/sum(x))

pstrdistmat <- vegan::vegdist(sqrt(otu_table(pstrr)), method = "bray")

pstrdf <- as.data.frame(cmdscale(pstrdistmat, k = 2)) %>%
  mutate(sample_name = rownames(.)) %>%
  left_join(sample_data(pstr)) %>%
  as_tibble() %>%
  select(V1, V2, sample_name, host_id, year, host_site, collection_depth) %>%
  arrange(host_id, year)

ggplot(pstrdf, aes(x = V1, y = V2, color = host_id)) +
  geom_point(aes(shape = year)) +
  geom_path(aes(group = host_id), arrow = arrow(length = unit(0.1, "inches"), type = "open")) +
  labs(title = "Just Breviolum-dominated P.str.")
```

### *Siderastrea siderea*
```{r siderea_summary, fig.width = 11}
plot_both2(host_species == "siderea")
```

*S. siderea* hosts mainly *Cladocopium* profiles that do not change over time. A couple of colonies (7 and 73) may have fluctuating levels of multiple *Cladocopium* types. One colony at Cabritte Horn (51) is dominated by *Breviolum*.

```{r}
# NMDS for Ssid
ssid <- merge_phyloseq(tax_table(variants), otu_table(variants), 
                       subset(sample_data(variants), host_species == "siderea" & host_id != "RANDOM"))
ssid <- prune_taxa(taxa_sums(ssid) != 0, ssid)
ssidr = transform_sample_counts(ssid, function(x) sqrt(x/sum(x)))

ssiddistmat <- vegan::vegdist(sqrt(otu_table(ssidr)), method = "bray")

ssiddf <- as.data.frame(cmdscale(ssiddistmat, k = 2)) %>%
  mutate(sample_name = rownames(.)) %>%
  left_join(sample_data(ssid)) %>%
  as_tibble() %>%
  select(V1, V2, sample_name, host_id, year, host_site, collection_depth) %>%
  arrange(host_id, year)

ggplot(ssiddf, aes(x = V1, y = V2, color = host_id)) +
  geom_point(aes(shape = year)) +
  geom_path(aes(group = host_id), arrow = arrow(length = unit(0.1, "inches"), type = "open"))
```

# Detailed figures for each coral colony

### Colpophyllia natans
```{r}
cnat <- data.frame(sam) %>%
  distinct(host_id, host_genus, host_species, host_site) %>%
  filter(host_species == "natans")

for (i in 1:nrow(cnat)) {
  p <- plot_both(mycol = cnat[i, "host_id"])
  print(p)
}
```

### Diploria labyrinthiformis
```{r}
dlab <- data.frame(sam) %>%
  distinct(host_id, host_genus, host_species, host_site) %>%
  filter(host_species == "labrynthiformis")

for (i in 1:nrow(dlab)) {
  p <- plot_both(mycol = dlab[i, "host_id"])
  print(p)
}
```

### Montastraea cavernosa
```{r}
mcav <- data.frame(sam) %>%
  distinct(host_id, host_genus, host_species, host_site) %>%
  filter(host_species == "cavernosa")

for (i in 1:nrow(mcav)) {
  p <- plot_both(mycol = mcav[i, "host_id"])
  print(p)
}
```


### Orbicella spp.
```{r}
orb <- data.frame(sam) %>%
  distinct(host_id, host_genus, host_species, host_site) %>%
  filter(host_genus == "Orbicella")

for (i in 1:nrow(orb)) {
  p <- plot_both(mycol = orb[i, "host_id"])
  print(p)
}
```

### Pseudodiploria strigosa
```{r}
pstr <- data.frame(sam) %>%
  distinct(host_id, host_genus, host_species, host_site) %>%
  filter(host_species == "strigosa")

for (i in 1:nrow(pstr)) {
  p <- plot_both(mycol = pstr[i, "host_id"])
  print(p)
}
```

### Siderastrea siderea
```{r}
ssid <- data.frame(sam) %>%
  distinct(host_id, host_genus, host_species, host_site) %>%
  filter(host_species == "siderea")

for (i in 1:nrow(ssid)) {
  p <- plot_both(mycol = ssid[i, "host_id"])
  print(p)
}
```